---
title: 瞬時計劃刻
description: 瞬時計劃刻 - Instant Tile Tick(ITT)
---

## 瞬時計劃刻 (Instant Tile Tick - ITT)

minecraft 為了在區塊裝飾時預先處理流體等方塊，故添加了本規則。(_**後續文章可能會使用 `ITT` 來代指它 \[瞬時計劃刻 Instant Tile Tick]**_)

由於 scheduledUpdatesAreImmediate 是放置在 World 的，也就代表該 flag 是依賴緯度的，各個緯度不會相互影響，值得一提的是現階段終界是無法獲取 ITT 的(由於不會放置水等流體)。

ITT 只會影響，範圍 $\pm8$ 方塊，也就是 16×16×16 方塊區域（剛好一個 chunk 大小）。

- `WorldGenHellLava` 地域岩漿
- `WorldGenLiquids` 基本流體
- `StructureNetherBridgePieces` 地域堡壘生成 (由於放置了 `FLOWING_LAVA` [流動岩漿])

::code-group
```java{2} [World.java] line-numbers
public abstract class World implements IBlockAccess {
  public boolean scheduledUpdatesAreImmediate; // [!code focus]
}
```

```java [WorldServer.java] line-numbers
public class WorldServer extends World implements IThreadListener {
  public void updateBlockTick(BlockPos pos, Block blockIn, int delay, int priority) {
    Material material = blockIn.getDefaultState().getMaterial();

    if (this.scheduledUpdatesAreImmediate && material != Material.AIR) {
      if (blockIn.requiresUpdates() && this.isAreaLoaded(pos.add(-8, -8, -8), pos.add(8, 8, 8))) {
        IBlockState iblockstate = this.getBlockState(pos);
        if (iblockstate.getMaterial() != Material.AIR && iblockstate.getBlock() == blockIn) {
          iblockstate.getBlock().updateTick(this, pos, iblockstate, this.rand);
        }
      }
      delay = 1;
    }

    NextTickListEntry nextticklistentry = new NextTickListEntry(pos, blockIn);
    if (this.isBlockLoaded(pos)) {
      if (material != Material.AIR) {
        nextticklistentry.setScheduledTime((long) delay + this.worldInfo.getWorldTotalTime());
        nextticklistentry.setPriority(priority);
      }

      if (!this.pendingTickListEntriesHashSet.contains(nextticklistentry)) {
        this.pendingTickListEntriesHashSet.add(nextticklistentry);
        this.pendingTickListEntriesTreeSet.add(nextticklistentry);
      }
    }
  }
}
```
::


## 在哪被修改

`scheduledUpdatesAreImmediate` 會在 `immediateBlockTick` 函數內被修改。

```java{3,5} [World.java] line-numbers
public abstract class World implements IBlockAccess {
  public void immediateBlockTick(BlockPos pos, IBlockState state, Random random) {
    this.scheduledUpdatesAreImmediate = true;
    state.getBlock().updateTick(this, pos, state, random);
    this.scheduledUpdatesAreImmediate = false;
  }
}
```

而 `immediateBlockTick` 會被下面這些代碼呼叫。

::code-group
```java{1,4,18,23,24} [WorldGenHellLava.java] collapse height=150 line-numbers
public class WorldGenHellLava extends WorldGenerator { // [!code focus] 地獄岩漿生成
  // ...

  public boolean generate(World worldIn, Random rand, BlockPos position) { // [!code focus]
    if (worldIn.getBlockState(position.up()).getBlock() != Blocks.NETHERRACK) {
      return false;
    }
    // ...
    else {
      int i = 0;
      int j = 0;

      // ...

      if (!this.insideRock && i == 4 && j == 1 || i == 5) {
        IBlockState iblockstate = this.block.getDefaultState();
        worldIn.setBlockState(position, iblockstate, 2);
        worldIn.immediateBlockTick(position, iblockstate, rand); // [!code focus]
      }

      return true;
    }
  } // [!code focus]
} // [!code focus]
```

```java{1,4,22,28,29} [WorldGenLiquids.java] collapse height=150 line-numbers
public class WorldGenLiquids extends WorldGenerator { // [!code focus] 基本流體生成
  // ...

  public boolean generate(World worldIn, Random rand, BlockPos position) { // [!code focus]
    if (worldIn.getBlockState(position.up()).getBlock() != Blocks.STONE) {
      return false;
    }
    // ...
    else {
      IBlockState iblockstate = worldIn.getBlockState(position);
      if (iblockstate.getMaterial() != Material.AIR && iblockstate.getBlock() != Blocks.STONE) {
        return false;
      } else {
        int i = 0;
        int j = 0;

        // ...

        if (i == 3 && j == 1) {
          IBlockState iblockstate1 = this.block.getDefaultState();
          worldIn.setBlockState(position, iblockstate1, 2);
          worldIn.immediateBlockTick(position, iblockstate1, rand); // [!code focus]
        }

        return true;
      }
    }
  } // [!code focus]
} // [!code focus]
```

```java{1,2,5,19,23,24,25} [StructureNetherBridgePieces.java] collapse height=150 line-numbers
public class StructureNetherBridgePieces { // [!code focus] 地獄要塞生成
  public static class Entrance extends StructureNetherBridgePieces.Piece { // [!code focus]
    // ...

    public boolean addComponentParts(World worldIn, Random randomIn, StructureBoundingBox structureBoundingBoxIn) { // [!code focus]
      // ... 填充各式方塊

      this.fillWithBlocks(worldIn, structureBoundingBoxIn, 5, 5, 5, 7, 5, 7,
          Blocks.NETHER_BRICK.getDefaultState(), Blocks.NETHER_BRICK.getDefaultState(), false);
      this.fillWithBlocks(worldIn, structureBoundingBoxIn, 6, 1, 6, 6, 4, 6, Blocks.AIR.getDefaultState(),
          Blocks.AIR.getDefaultState(), false);
      this.setBlockState(worldIn, Blocks.NETHER_BRICK.getDefaultState(), 6, 0, 6, structureBoundingBoxIn);
      IBlockState iblockstate = Blocks.FLOWING_LAVA.getDefaultState();
      this.setBlockState(worldIn, iblockstate, 6, 5, 6, structureBoundingBoxIn);
      BlockPos blockpos = new BlockPos(this.getXWithOffset(6, 6), this.getYWithOffset(5),
          this.getZWithOffset(6, 6));

      if (structureBoundingBoxIn.isVecInside(blockpos)) {
        worldIn.immediateBlockTick(blockpos, iblockstate, randomIn); // [!code focus]
      }

      return true;
    } // [!code focus]
  } // [!code focus]
} // [!code focus]
```
::

## 如何開啟

在區塊生成(裝飾)時，會開啟 `ITT`，並放置水、岩漿等方塊。
由於 ITT 開啟，這些方塊會立刻流動完畢。若此時產生更新抑制，後續程式（包含關閉 `ITT`）會被跳過，導致 ITT 未被關閉。

## 如何關閉

1. 重啟服務器
2. 重新加載之前未被加載過的區塊 (裝飾)

## 開啟時影響

### 偵測器

開啟後偵測器檢測偵測器時，不管是亮還是滅都會被下一個偵測器檢測到，造成**指數級更新**。請注意不要在主線程放置會導致主線程卡死並觸發 WatchDog 超時崩潰。

### 注意事項

1. 不可再主進程放置臉對臉或長偵測器鏈等會造成指數級更新的方塊，這會導致主線程卡死
2. 不可放置及更新:

::div{class="ml-4"}
- 冰霜
- 絆線鉤
- 壓力板 ~~< 請特別注意他，由其是神奇村莊 !!! 會有一堆神奇壓力版桌子，村民會碰到 :smart-icon{name="😭"}~~
- 感測鐵軌
- 減法比較器高頻
::
